<!DOCTYPE html>
<!--  This site was created in Webflow. http://www.webflow.com  -->
<!--  Last Published: Mon Jul 13 2020 22:20:45 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="5ecc51b9df7e1d101c3fc1c6" data-wf-site="5ec2ba8457c5c50b20b387c9">
{% include 'header.html' %}
<body>
  {% include 'navbar.html' %}
  <div class="columns w-row">
    {% include 'project-pages/menu.html' %}
    <div class="column w-col w-col-11">
      <div data-duration-in="300" data-duration-out="100" class="tabs-3 w-tabs" style="height:100%">
        <div class="tabs-menu w-clearfix w-tab-menu">
          <a data-w-tab="Tab 1" class="tab-link-tab-1 w-inline-block w-tab-link w--current">
            <div class="text-block-23">Network subnets</div>
          </a>
          <a data-w-tab="Tab 2" class="tab-link-tab-2 w-inline-block w-tab-link">
            <div class="text-block-23">Network graph</div>
          </a>
        </div>
        <div class="w-tab-content" style="height:100%">
          <div data-w-tab="Tab 1" class="w-tab-pane w--tab-active">
            <div class="w-row">
              <div class="w-clearfix w-col w-col-6">
                {% set networks=db.select_project_networks(current_project['id']) %}
                <h1 class="heading-3">Network subnets: {{len(networks)}}</h1>
              </div>
              <div class="w-clearfix w-col w-col-6">
                <a href="/project/{{current_project['id']}}/networks/new_network" class="addnetwork w-button">Add</a>
              </div>
            </div>

            <!-- -->
            <script>
                $(document).ready(function() {
                    var table = $('#example').DataTable( {
                        "order": [[ 1, "asc" ]],
                        "iDisplayLength": 100,
                        aLengthMenu: [
                            [10, 25, 50, 100, 200, -1],
                            [10, 25, 50, 100, 200, "All"]
                        ],
                        "columnDefs": [
                            {
                                "targets": 0,
                                "width": "15.6666666%"
                            },
                            {
                                "targets":1,
                                "width": "15.6666666%"
                            },
                            {
                                "targets":2,
                                "width": "15.6666666%"
                            },
                            {
                                "targets":3,
                                "width": "15.6666666%"
                            },
                            {
                                "targets": 4,
                                "width": "15.6666666%"
                            },
                            {
                                "targets": 5,
                                "width": "15.6666666%"
                            },
                            {
                                "targets": 6,
                                "orderable": false,
                                "width": "6%"
                            }
                        ]
                    } );
                } );
            </script>

            <table id="example" class="display" style="width:100%">
                <thead>
                    <tr id="table_header">
                        <th id="visible_column" style="border-top-left-radius: 8px;"><h4>Network</h4></th>
                        <th id="visible_column"><h4>Access from</h4></th>
                        <th id="visible_column"><h4>Internal IP</h4></th>
                        <th id="visible_column"><h4>Connect command</h4></th>
                        <th id="visible_column"><h4>Comment</h4></th>
                        <th id="visible_column" style="border-top-right-radius: 8px;"><h4>ASN</h4></th>
                        <th style="background-color: white"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for network in networks %}
                    <tr>
                        <td>
                            <div class="text-block-20">{{escape(network['ip'])}}/{{escape(network['mask'])}}</div>
                        </td>
                        <td>
                              {% set addresses = json_unpack(network['access_from']) %}
                              {% set counter = [0] %}
                              {% for port_id in addresses %}
                                  {% set port = db.select_port(port_id)[0] %}
                                  {% for host in addresses[port_id] %}
                                      {% if counter[0] < 5 %}
                                          {% if host=="0" %}
                                              {% set ip = db.select_host_by_port_id(port_id)[0] %}
                                              <div class="text-block-26">{{escape(ip['ip'])}}{% if port['port'] != 0 %}:{{escape(port['port'])}}{% endif %}</div>
                                          {% else %}
                                              {% set hostname = db.select_hostname(host)[0] %}
                                              <div class="text-block-26">{{escape(hostname['hostname'])}}{% if port['port'] != 0 %}:{{escape(port['port'])}}{% endif %}</div>
                                          {% endif %}
                                      {% endif %}
                                      {% if counter.append(counter.pop() + 1) %}{% endif %}
                                  {% endfor %}
                              {% endfor %}
                              {% if counter[0] >5 %}
                                <div class="text-block-26"> ... </div>
                                <div class="text-block-26"> {{counter[0]}} hosts at all! </div>
                              {% endif %}
                        </td>
                        <td>
                            <div class="text-block-20">{{escape(network['internal_ip'])}}</div>
                        </td>
                        <td>
                            <div class="text-block-20" style="word-break: break-all; white-space:pre-wrap;">{{escape(network['cmd'])}}</div>
                        </td>
                        <td>
                            <div class="text-block-22" style="word-break: break-all; white-space:pre-wrap;">{{escape(network['comment'])}}</div>
                        </td>
                        <td>
                            {% if network['asn'] != 0 and network['asn'] != None %}
                                <div class="text-block-22">ASN{{escape(network['asn'])}} <a href="https://ipinfo.io/AS{{network['asn']}}">(ipinfo)</a> <a href="https://bgp.he.net/AS{{network['asn']}}">(bgp)</a></div>
                            {% endif %}
                        </td>
                        <td style="background-color: white">
                            <a href="/project/{{current_project['id']}}/hosts/?network={{network['id']}}"><img src="/static/images/search.png" style="width: 100%; max-width: 40px; cursor: pointer;"></a>
                            <a href="/project/{{current_project['id']}}/networks/{{network['id']}}/"><img src="/static/images/edit.png" style="width: 100%; max-width: 40px; cursor: pointer;"></a>
                            <!-- <form method="post" action="/project/{{current_project['id']}}/networks/delete_network" onsubmit="return delete_prompt(this,'Are you sure to delete network {{network['ip']}}/{{network['mask']}}?')">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                              <input type="hidden" name="network_id" value="{{ network['id'] }}"/>
                              <button type="submit" class="button-35 w-button">Delete</button>
                            </form> -->
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
          <style>
                th{
                    padding:0px;
                    margin-top: 0px;
                    margin-bottom: 0px;
                    height: 30px;
                }
                h4{
                    margin-top: 0px; margin-bottom: 0px; text-align: left; padding-left: 10px
                }
                table.dataTable thead th, table.dataTable thead td{
                    padding: 0px 0px;
                    height: 30px;
                    background-color: #c0f7ff;
                }
                table.dataTable.stripe tbody tr.odd, table.dataTable.display tbody tr.odd{
                    background-color: #fffdc2;
                }
                table.dataTable.stripe tbody tr.odd, table.dataTable.display tbody tr.even{
                    background-color: #c3ffcd;
                }
                .custom-clickable-row {
                    cursor: pointer;
                }
                .dataTable tr:hover td {
                    background-color: lightgrey;
                }
                .dataTable tr:hover tr > .sorting_1 {
                    background-color: lightgrey;
                }
                table.dataTable.display tbody tr.odd > .sorting_1, table.dataTable.order-column.stripe tbody tr.odd > .sorting_1{
                    background-color: transparent;
                }
                table.dataTable.display tbody tr.even > .sorting_1, table.dataTable.order-column.stripe tbody tr.even > .sorting_1{
                    background-color: transparent;
                }
                table.dataTable.display tbody tr.odd:hover > .sorting_1, table.dataTable.order-column.stripe tbody tr.odd:hover > .sorting_1{
                    background-color: lightgrey;
                }
                table.dataTable.display tbody tr.even:hover > .sorting_1, table.dataTable.order-column.stripe tbody tr.even:hover > .sorting_1{
                    background-color: lightgrey;
                }
                table.dataTable tbody th, table.dataTable tbody td {
                    padding: 0px 0px;
                    padding-top: 5px;
                    padding-bottom: 5px;
                }
                div.dt-buttons {
                    position: relative;
                    float: left;
                    margin-left: 15px;
                }
                table.dataTable thead th {
                  border-bottom: 0;
                }
                table.dataTable tfoot th {
                  border-top: 0;
                }
                 table.dataTable tbody tr {
                  border-bottom: 0;
                }
                table.dataTable tbody tr {
                  border-top: 0;
                }
                tbody tr {
                  vertical-align: top;
                }
            </style>
          </div>
          <div data-w-tab="Tab 2" class="tab-pane-tab-2 w-tab-pane" style="height:100%">
              <div class="div-block-6" style="height:100%">
              <!--<img src="/static/images/maxresdefault.jpg" srcset="/static/images/maxresdefault-p-500.jpeg 500w, /static/images/maxresdefault-p-800.jpeg 800w, /static/images/maxresdefault-p-1080.jpeg 1080w, /static/images/maxresdefault.jpg 1280w" sizes="(max-width: 767px) 100vw, (max-width: 991px) 92vw, (max-width: 1361px) 94vw, 1280px" alt=""> -->
              <script type="text/javascript">
                  var nodes = null;
                  var edges = null;
                  var network = null;

                  var hosts_arr = [];

                  {% set json_obj = db.select_hosts_json(current_project['id']) %}
                  var hosts_arr = {{ json_obj[0] | safe }};

                  var networks_arr = [];

                  var networks_arr = {{ json_obj[1] | safe }};

                  var network_global = {"id": -1, "network": "0.0.0.0", "mask": 0, "description":"global"}

                  function gen_name(host_obj){
                      let name = host_obj["ip"];
                      if (host_obj["threads"].length){
                          name += "\n";
                      }
                      for (var i = 0; i < host_obj["threads"].length; i++) {
                          if (host_obj["threads"][i]==="check"){
                              name += "❔";
                          } else if (host_obj["threads"][i]==="checked"){
                              name += "🚩";
                          } else if (host_obj["threads"][i]==="info"){
                              name += "🔵";
                          } else if (host_obj["threads"][i]==="low"){
                              name += "🟢";
                          } else if (host_obj["threads"][i]==="medium"){
                              name += "🟠";
                          } else if (host_obj["threads"][i]==="high"){
                              name += "🔴";
                          }
                      }
                      return name;
                  }

                  function get_picture(os_system){
                      if (os_system === null){
                          return '/static/images/server.png'
                      } else if (os_system.toLowerCase().includes('windows')){
                          return '/static/images/windows.png'
                      } else if (os_system.toLowerCase().includes('mac')) {
                          return '/static/images/macos.png'
                      } else if (os_system.toLowerCase().includes('linux')) {
                          return '/static/images/linux.png'
                      } else {
                          return '/static/images/no_os.png'
                      }
                  }

                  var DIR = "/static/images/";
                  var EDGE_LENGTH_MAIN = 350;
                  var EDGE_LENGTH_SUB = 50;

                  // Called when the Visualization API is loaded.
                  function draw() {
                    // Create a data table with nodes.
                    nodes = [];

                    function IPnumber(IPaddress) {
                        var ip = IPaddress.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
                        if(ip) {
                            return (+ip[1]<<24) + (+ip[2]<<16) + (+ip[3]<<8) + (+ip[4]);
                        }
                        return null;
                    }

                    function IPmask(maskSize) {
                        return -1<<(32-maskSize)
                    }

                    // Create a data table with links.
                    edges = [];
                    var hosts_len = hosts_arr.length;
                    for (var i = 0; i < hosts_len; i++) {
                        nodes.push({
                          id: hosts_arr[i]["id"],
                          label: gen_name(hosts_arr[i]),
                          image: get_picture(hosts_arr[i]["os"]),
                          shape: "image"
                        });
                    }

                    var networks_len = networks_arr.length;
                    for (var i = 0; i < networks_len; i++) {
                        nodes.push({
                          id: networks_arr[i]["id"],
                          label: networks_arr[i]["network"] + "/" + networks_arr[i]["mask"],
                          image: get_picture(null),
                          shape: "image"
                        });
                    }

                    nodes.push({
                      id: network_global["id"],
                      label: network_global["network"] + "/" + network_global["mask"],
                      image: get_picture(null),
                      shape: "image"
                    });

                    for (var x = 0; x < hosts_len; x++) {
                        let found = 0;
                        for (var i = 0; i < networks_len; i++) {
                            if( (IPnumber(hosts_arr[x]["ip"]) & IPmask(networks_arr[i]["mask"].toString())) == IPnumber(networks_arr[i]["network"])){
                                edges.push({ from: hosts_arr[x]["id"], to: networks_arr[i]["id"], length: EDGE_LENGTH_MAIN });
                                found = 1;
                            }
                        }
                        if (!found){
                            edges.push({ from: hosts_arr[x]["id"], to: network_global["id"], length: EDGE_LENGTH_MAIN });
                        }
                    }


                    // create a network
                    var container = document.getElementById("mynetwork");
                    var data = {
                      nodes: nodes,
                      edges: edges,
                    };
                    var options = {};
                    network = new vis.Network(container, data, options);
                  }
                </script>
                <div id="mynetwork" style="height: 80vh"></div>
                <script>draw();</script>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% include 'footer.html' %}
</body>
</html>