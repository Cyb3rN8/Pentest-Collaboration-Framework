<!DOCTYPE html>
<!--  This site was created in Webflow. http://www.webflow.com  -->
<!--  Last Published: Mon Jul 13 2020 22:20:45 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="5ecc51b9df7e1d101c3fc1c6" data-wf-site="5ec2ba8457c5c50b20b387c9">
{% include 'header.html' %}
<body>
  {% include 'navbar.html' %}
  <div class="columns w-row">
    {% include 'project-pages/menu.html' %}
    <div class="column w-col w-col-11">
      <div data-duration-in="300" data-duration-out="100" class="tabs-3 w-tabs" style="height:100%">
        <div class="tabs-menu w-clearfix w-tab-menu">
          <a data-w-tab="Tab 1" class="tab-link-tab-1 w-inline-block w-tab-link w--current">
            <div class="text-block-23">Network subnets</div>
          </a>
          <a data-w-tab="Tab 2" class="tab-link-tab-2 w-inline-block w-tab-link">
            <div class="text-block-23">Network graph</div>
          </a>
        </div>
        <div class="w-tab-content" style="height:100%">
          <div data-w-tab="Tab 1" class="w-tab-pane w--tab-active">
            <div class="w-row">
              <div class="w-clearfix w-col w-col-6">
                {% set networks=db.select_project_networks(current_project['id']) %}
                <h1 class="heading-3">Network subnets: {{len(networks)}}</h1>
              </div>
              <div class="w-clearfix w-col w-col-6">
                <a href="/project/{{current_project['id']}}/networks/new_network" class="addnetwork w-button">Add</a>
              </div>
            </div>
            <div class="columns-7 w-row">
              <div class="column-24 w-col w-col-2">
                <div class="text-block-17">ip-address</div>
              </div>
              <div class="column-25 w-col w-col-2">
                <div class="text-block-18">subnet mask</div>
              </div>
              <div class="column-26 w-col w-col-4">
                <div class="text-block-19">comment</div>
              </div>
              <div class="column-23 w-col w-col-2">
                <div class="text-block-19">ASN</div>
              </div>
              <div class="column-229 w-col w-col-2"></div>
            </div>

            <!-- -->



            {% for network in networks %}

                {% if loop.index % 2  == 0 %}
                    <div class="columns-8 w-row">
                {% else %}
                    <div class="columns-9 w-row">
                {% endif %}
                  <div class="column-27 w-col w-col-2">
                    <div class="text-block-20">{{escape(network['ip'])}}</div>
                  </div>
                  <div class="column-28 w-col w-col-2">
                    <div class="text-block-21">/{{escape(network['mask'])}}</div>
                  </div>
                  <div class="column-29 w-col w-col-4">
                    <div class="text-block-22" style="word-break: break-all; white-space:pre-wrap;">{{escape(network['comment'])}}</div>
                  </div>
                  <div class="column-30 w-col w-col-2">
                      {% if network['asn'] != 0 and network['asn'] != None %}
                          <div class="text-block-22">ASN{{escape(network['asn'])}} <a href="https://ipinfo.io/AS{{network['asn']}}">(ipinfo)</a> <a href="https://bgp.he.net/AS{{network['asn']}}">(bgp)</a></div>
                      {% endif %}
                  </div>
                  <div class="column-228 w-col w-col-2">
                    <a href="/project/{{current_project['id']}}/hosts/?network={{network['id']}}" class="button-14 w-button">Filter</a>
                    <form method="post" action="/project/{{current_project['id']}}/networks/delete_network" onsubmit="return delete_prompt(this,'Are you sure to delete network {{network['ip']}}/{{network['mask']}}?')">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                      <input type="hidden" name="network_id" value="{{ network['id'] }}"/>
                      <button type="submit" class="button-35 w-button">Delete</button>
                    </form>
                  </div>
                </div>

            {% endfor %}

            <!-- -->

          </div>
          <div data-w-tab="Tab 2" class="tab-pane-tab-2 w-tab-pane" style="height:100%">
              <div class="div-block-6" style="height:100%">
              <!--<img src="/static/images/maxresdefault.jpg" srcset="/static/images/maxresdefault-p-500.jpeg 500w, /static/images/maxresdefault-p-800.jpeg 800w, /static/images/maxresdefault-p-1080.jpeg 1080w, /static/images/maxresdefault.jpg 1280w" sizes="(max-width: 767px) 100vw, (max-width: 991px) 92vw, (max-width: 1361px) 94vw, 1280px" alt=""> -->
              <script type="text/javascript" src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"></script>
              <script type="text/javascript">
                  var nodes = null;
                  var edges = null;
                  var network = null;

                  var hosts_arr = [
                      {"id":1, "ip": "1.1.1.1", "os": "windows", "description": "cool descr", "threads": ["info", "low"]},
                      {"id":2, "ip": "2.2.2.2", "os": "linux", "description": "cool descr", "threads": ["low", "medium"]},
                      {"id":3, "ip": "3.3.3.3", "os": "macos", "description": "cool descr", "threads": ["high", "check", "checked"]},
                      {"id":4, "ip": "4.4.4.4", "os": "Ubuntu Linux", "description": "cool descr", "threads": ["info", "low", "checked"]},
                      {"id":5, "ip": "5.5.5.5", "os": "Windows Server 2008", "description": "cool descr", "threads": ["check", "checked"]},
                      {"id":6, "ip": "6.6.6.6", "os": "macos", "description": "cool descr", "threads": ["info", "low"]},
                      {"id":7, "ip": "7.7.7.7", "os": "windows", "description": "cool descr", "threads": ["info", "checked"]},
                      {"id":8, "ip": "3.3.3.4", "os": "macos", "description": "cool descr", "threads": ["high"]}
                  ];

                  {% set json_obj = db.select_hosts_json(current_project['id']) %}
                  var hosts_arr = {{ json_obj[0] | safe }};

                  var networks_arr = [
                      {"id": 9, "network": "3.3.3.0", "mask": 24, "description":"cool description"},
                      {"id": 10, "network": "2.2.2.0", "mask": 24, "description":"cool description1"}
                  ];

                  var networks_arr = {{ json_obj[1] | safe }};

                  var network_global = {"id": -1, "network": "0.0.0.0", "mask": 32, "description":"global"}

                  function gen_name(host_obj){
                      let name = host_obj["ip"];
                      if (host_obj["threads"].length){
                          name += "\n";
                      }
                      for (var i = 0; i < host_obj["threads"].length; i++) {
                          if (host_obj["threads"][i]==="check"){
                              name += "❔";
                          } else if (host_obj["threads"][i]==="checked"){
                              name += "🚩";
                          } else if (host_obj["threads"][i]==="info"){
                              name += "🔵";
                          } else if (host_obj["threads"][i]==="low"){
                              name += "🟢";
                          } else if (host_obj["threads"][i]==="medium"){
                              name += "🟠";
                          } else if (host_obj["threads"][i]==="high"){
                              name += "🔴";
                          }
                      }
                      return name;
                  }

                  function get_picture(os_system){
                      if (os_system === null){
                          return '/static/images/server.png'
                      } else if (os_system.toLowerCase().includes('windows')){
                          return '/static/images/windows.png'
                      } else if (os_system.toLowerCase().includes('mac')) {
                          return '/static/images/macos.png'
                      } else {
                          return '/static/images/no_os.png'
                      }
                  }

                  var DIR = "/static/images/";
                  var EDGE_LENGTH_MAIN = 350;
                  var EDGE_LENGTH_SUB = 50;

                  // Called when the Visualization API is loaded.
                  function draw() {
                    // Create a data table with nodes.
                    nodes = [];

                    function IPnumber(IPaddress) {
                        var ip = IPaddress.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
                        if(ip) {
                            return (+ip[1]<<24) + (+ip[2]<<16) + (+ip[3]<<8) + (+ip[4]);
                        }
                        return null;
                    }

                    function IPmask(maskSize) {
                        return -1<<(32-maskSize)
                    }

                    // Create a data table with links.
                    edges = [];
                    var hosts_len = hosts_arr.length;
                    for (var i = 0; i < hosts_len; i++) {
                        nodes.push({
                          id: hosts_arr[i]["id"],
                          label: gen_name(hosts_arr[i]),
                          image: get_picture(hosts_arr[i]["os"]),
                          shape: "image"
                        });
                    }

                    var networks_len = networks_arr.length;
                    for (var i = 0; i < networks_len; i++) {
                        nodes.push({
                          id: networks_arr[i]["id"],
                          label: networks_arr[i]["network"] + "/" + networks_arr[i]["mask"],
                          image: get_picture(null),
                          shape: "image"
                        });
                    }

                    nodes.push({
                      id: network_global["id"],
                      label: network_global["network"] + "/" + network_global["mask"],
                      image: get_picture(null),
                      shape: "image"
                    });

                    for (var x = 0; x < hosts_len; x++) {
                        let found = 0;
                        for (var i = 0; i < networks_len; i++) {
                            if( (IPnumber(hosts_arr[x]["ip"]) & IPmask(networks_arr[i]["mask"].toString())) == IPnumber(networks_arr[i]["network"])){
                                edges.push({ from: hosts_arr[x]["id"], to: networks_arr[i]["id"], length: EDGE_LENGTH_MAIN });
                                found = 1;
                            }
                        }
                        if (!found){
                            edges.push({ from: hosts_arr[x]["id"], to: network_global["id"], length: EDGE_LENGTH_MAIN });
                        }
                    }


                    // create a network
                    var container = document.getElementById("mynetwork");
                    var data = {
                      nodes: nodes,
                      edges: edges,
                    };
                    var options = {};
                    network = new vis.Network(container, data, options);
                  }
                </script>
                <div id="mynetwork" style="height: 100vh"></div>
                  <script>draw();</script>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% include 'footer.html' %}
</body>
</html>