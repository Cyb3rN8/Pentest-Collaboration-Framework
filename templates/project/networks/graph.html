<!DOCTYPE html>
<html lang="en">
{% include 'header.html' %}
<body>
<div id="segment_id">
    {% include 'menu.html' %}
    <div class="ui grid">
        <div class="ui column" style="width: 75px; padding-top: 50px;">
            {% include 'project/sidebar.html' %}
        </div>
        <div class="ui column" style="width: calc(100% - 75px)">
            {% if external_js %}
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
            {% else %}
                <script type="text/javascript" src="/static/js/vis-network.min.js"></script>
            {% endif %}
            <div class="div-block-6" style="height:100%">
                <script type="text/javascript">
                    var nodes = null;
                    var edges = null;
                    var network = null;

                    var hosts_arr = [];

                    {% set json_obj = db.select_hosts_json(current_project['id']) %}
                    var hosts_arr = {{ json_obj[0] | safe }};

                    var networks_arr = [];

                    var networks_arr = {{ json_obj[1] | safe }};

                    var network_global = {"id": -1, "network": "0.0.0.0", "mask": 0, "description": "global"}

                    function gen_name(host_obj) {
                        let name = host_obj["ip"];
                        if (host_obj["threads"].length) {
                            name += "\n";
                        }
                        counter = 0;
                        for (var i = 0; i < host_obj["threads"].length; i++) {
                            if (host_obj["threads"][i] === "check") {
                                name += "❔";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "checked") {
                                name += "🚩";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "info") {
                                name += "🔵";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "low") {
                                name += "🟢";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "medium") {
                                name += "🟠";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "high") {
                                name += "🔴";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "scope") {
                                name += "🎯";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "firewall") {
                                name += "🛡️";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "inwork") {
                                name += "🔄";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "critical") {
                                name += "💣";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "slow") {
                                name += "🐌";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "recheck") {
                                name += "📝";
                                counter += 1;
                            } else if (host_obj["threads"][i] === "noscope") {
                                name += "⛔";
                                counter += 1;
                            }

                            if (counter === 4) {
                                name += '\n';
                                counter = 0;
                            }
                        }
                        return name;
                    }

                    function get_picture(os_system) {
                        if (os_system === null) {
                            return '/static/images/server.png'
                        } else if (os_system.toLowerCase().includes('windows')) {
                            return '/static/images/windows.png'
                        } else if (os_system.toLowerCase().includes('mac')) {
                            return '/static/images/macos.png'
                        } else if (os_system.toLowerCase().includes('linux')) {
                            return '/static/images/linux.png'
                        } else {
                            return '/static/images/no_os.png'
                        }
                    }

                    var DIR = "/static/images/";
                    var EDGE_LENGTH_MAIN = 350;
                    var EDGE_LENGTH_SUB = 50;

                    // Called when the Visualization API is loaded.
                    function draw() {
                        // Create a data table with nodes.
                        nodes = [];

                        function IPnumber(IPaddress) {
                            var ip = IPaddress.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
                            if (ip) {
                                return (+ip[1] << 24) + (+ip[2] << 16) + (+ip[3] << 8) + (+ip[4]);
                            }
                            return null;
                        }

                        function IPmask(maskSize) {
                            return -1 << (32 - maskSize)
                        }

                        // Create a data table with links.
                        edges = [];
                        var hosts_len = hosts_arr.length;
                        for (var i = 0; i < hosts_len; i++) {
                            nodes.push({
                                id: hosts_arr[i]["id"],
                                label: gen_name(hosts_arr[i]),
                                image: get_picture(hosts_arr[i]["os"]),
                                shape: "image"
                            });
                        }

                        var networks_len = networks_arr.length;
                        for (var i = 0; i < networks_len; i++) {
                            nodes.push({
                                id: networks_arr[i]["id"],
                                label: networks_arr[i]["network"] + "/" + networks_arr[i]["mask"],
                                image: get_picture(null),
                                shape: "image"
                            });
                        }

                        nodes.push({
                            id: network_global["id"],
                            label: network_global["network"] + "/" + network_global["mask"],
                            image: get_picture(null),
                            shape: "image"
                        });

                        for (var x = 0; x < hosts_len; x++) {
                            let found = 0;
                            for (var i = 0; i < networks_len; i++) {
                                if ((IPnumber(hosts_arr[x]["ip"]) & IPmask(networks_arr[i]["mask"].toString())) == (IPnumber(networks_arr[i]["network"]) & IPmask(networks_arr[i]["mask"].toString()))) {
                                    edges.push({
                                        from: hosts_arr[x]["id"],
                                        to: networks_arr[i]["id"],
                                        length: EDGE_LENGTH_MAIN
                                    });
                                    found = 1;
                                }
                            }
                            if (!found) {
                                edges.push({
                                    from: hosts_arr[x]["id"],
                                    to: network_global["id"],
                                    length: EDGE_LENGTH_MAIN
                                });
                            }
                        }


                        // create a network
                        var container = document.getElementById("mynetwork");
                        var data = {
                            nodes: nodes,
                            edges: edges,
                        };
                        var options = {};
                        network = new vis.Network(container, data, options);
                    }
                </script>
                <div id="mynetwork" style="height: 80vh"></div>
                <script>draw();</script>
            </div>
        </div>
        {% include 'footer.html' %}
    </div>
</div>
</body>
</html>