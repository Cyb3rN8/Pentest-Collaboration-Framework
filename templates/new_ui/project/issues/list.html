<!DOCTYPE html>
<html lang="en">
{% include 'new_ui/header.html' %}
<body>
{% include 'new_ui/menu.html' %}
<div class="ui grid">
    <div class="ui column" style="width: 75px; padding-top: 50px;">
        {% include 'new_ui/project/sidebar.html' %}
    </div>
    <div class="ui column" style="width: calc(100% - 75px)">
        <div>
            {% set issues = db.select_project_issues(current_project['id']) %}
            <h1 class="ui header" style="float: left">Issues: {{ len(issues) }}</h1>
            <a class="ui button blue" style="float:right" href="/project/{{ current_project['id'] }}/new_issue"><i class="plus icon"></i>Add</a>
            <div class="ui divider" style="float:left; width: 100%"></div>
        </div>
        <script>
            $(document).ready(function () {
                var table = $('#issues_list').DataTable({
                    "order": [[3, "desc"]],
                    "iDisplayLength": -1,
                    aLengthMenu: [
                        [10, 25, 50, 100, 200, -1],
                        [10, 25, 50, 100, 200, "All"]
                    ],
                    'columnDefs': [{
                        'targets': 5,
                        'searchable': false,
                        'orderable': false,
                    }]
                });

                rows = document.getElementsByTagName("tr");
                i = 1;
                while (i < rows.length){
                    cvss = parseFloat(rows[i].children[3].innerText);
                    console.log(cvss);
                    if (cvss ==0){
                        rows[i].style.backgroundColor = '#c0f7ff';
                    } else if (cvss <= 3.9) {
                        rows[i].style.backgroundColor = '#c3ffcd';
                    } else if (cvss <= 6.9) {
                        rows[i].style.backgroundColor = '#fffdc2';
                    } else if (cvss <= 8.9) {
                        rows[i].style.backgroundColor = '#f3c375';
                    } else {
                        rows[i].style.backgroundColor = '#ffb2b2';
                    }
                    i++;
                }
            });
        </script>
        <style>
            tr.odd {
                background-color: #fffdc2;
            }

            tr.even {
                background-color: #c3ffcd;
            }

            .ui.menu:last-child {
                margin-bottom: 0px;
            }
        </style>
        <div class="ui container" style="width: 100%;float:left;">
            <table id="issues_list" class="ui table" style="width: 100%">
                <thead>
                <tr id="table_header">
                    <th style="width: 200px;"><h4>name</h4></th>
                    <th style="width: 800px;"><h4>description</h4></th>
                    <th style="min-width: 300px;"><h4>services</h4></th>
                    <th style="min-width: 100px;"><h4>CVSS</h4></th>
                    <th><h4>status</h4></th>
                    <th><h4>action</h4></th>
                </tr>
                </thead>
                <tbody>
                {% for issue in issues %}
                    <tr>
                        <td style="word-break: break-all; white-space:pre-wrap;"><b>{{ escape(issue['name']) }}</b></td>
                        <td style="word-break: break-all; white-space:pre-wrap;">{{ escape('\n'.join(issue['description'].split('\n')[:5])) }}</td>
                        <td>
                            <ul class="ui list">
                                {% set addresses = json_unpack(issue['services']) %}
                                {% set counter = [0] %}
                                {% for port_id in addresses %}
                                    {% set port = db.select_port(port_id)[0] %}
                                    {% for host in addresses[port_id] %}
                                        {% if counter[0] < 5 %}
                                            {% if host=="0" %}
                                                {% set ip = db.select_host_by_port_id(port_id)[0] %}
                                                <li>
                                                    {{ escape(ip['ip']) }}{% if port['port'] != 0 %}:
                                                        {{ escape(port['port']) }}{% endif %}</li>
                                            {% else %}
                                                {% set hostname = db.select_hostname(host)[0] %}
                                                <li>
                                                    {{ escape(hostname['hostname']) }}{% if port['port'] != 0 %}:
                                                        {{ escape(port['port']) }}{% endif %}</li>
                                            {% endif %}
                                        {% endif %}
                                        {% if counter.append(counter.pop() + 1) %}{% endif %}
                                    {% endfor %}
                                {% endfor %}
                                {% if counter[0] >5 %}
                                    ...<br/>
                                    {{ counter[0] }} hosts at all!
                                {% endif %}
                            </ul>
                        </td>
                        <td>{{ escape(issue['cvss']) }}</td>
                        <td>{{ escape(issue['status']) }}</td>
                        <td><a class="ui button blue"
                               href="/project/{{ current_project['id'] }}/issue/{{ issue['id'] }}/">Open</a></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% include 'new_ui/footer.html' %}
</div>
</body>
</html>