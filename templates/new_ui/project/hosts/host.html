<!DOCTYPE html>
<html lang="en">
{% include 'new_ui/header.html' %}
<body>
<div id="segment_id">
    {% include 'new_ui/menu.html' %}
    <script>
        $(document).ready(function () {
            $('#hosts_tab_names .item').tab({
                history: true,
                historyType: 'hash'
            });

            service_dropdown = $('#services_list').dropdown();

            $('#os_list').dropdown();

            $('#ports_list').DataTable(
                {
                    "order": [[0, "asc"]],
                    "iDisplayLength": -1,
                    "searching": false,
                    "paging": false,
                    "info": false,
                    "padding": false,
                    "aocolumnDefs": [
                        {
                            "sType": "num"
                        },
                        {
                            "sType": "string"
                        },
                        {
                            "sType": "string"
                        },
                        null,
                        null
                    ],
                    "columnDefs": [
                        {
                            "orderable": false,
                            targets: 3
                        },
                        {
                            "orderable": false,
                            targets: 4
                        }
                    ]
                }
            );

            $('#hostnames_list').DataTable(
                {
                    "order": [[0, "asc"]],
                    "iDisplayLength": -1,
                    "searching": false,
                    "paging": false,
                    "info": false,
                    "padding": false,
                    "aocolumnDefs": [
                        {
                            "sType": "string"
                        },
                        {
                            "sType": "string"
                        },
                        null
                    ],
                    "columnDefs": [
                        {
                            "orderable": false,
                            targets: 2
                        }
                    ]
                }
            );

            $('.message .close')
                .on('click', function () {
                    $(this)
                        .closest('.message')
                        .transition('fade')
                    ;
                });
            $('#host_menu').sticky({context: '#host_tabs'});
        });

        function delete_prompt(func, message) {
            if (confirm(message))
                return true;
            return false;
        };

        function copy_data(loop_index) {
            document.getElementById("port").value = document.getElementById("port_num_" + loop_index).textContent;
            document.getElementById("port_descr").value = document.getElementById("port_description_" + loop_index).textContent;
            document.getElementById("service_text").value = "";
            service_text = document.getElementById("port_service_" + loop_index).textContent;
            if (!service_text) {
                service_text = 'other';
            }

            if (!service_field) {
                select = document.getElementById('services_list');
                var service_field = document.createElement('option');
                service_field.setAttribute("id", "port_service");
                select.prepend(service_field);
            }
            service_field.value = service_text;
            service_field.textContent = service_text;
            service_field.selected = 'selected';

            $('#services_list').dropdown('refresh');

            var element = document.getElementById('port_edit_form');
            element.scrollIntoView({
                block: 'start',
                behavior: 'smooth'
            });
        }

        function copy_hostname(loop_index) {
            document.getElementById("hostname_field").value = document.getElementById("hostname_" + loop_index).textContent;
            document.getElementById("hostname_comment").value = document.getElementById("hostname_comment_" + loop_index).textContent;
            var element = document.getElementById('add_hostname_form');
            element.scrollIntoView({
                block: 'start',
                behavior: 'smooth'
            });
        }
    </script>
    <style>
        tr.odd {
            background-color: #fffdc2;
        }

        tr.even {
            background-color: #c3ffcd;
        }

        #ports_list {
            word-wrap: break-word;
        }
    </style>
    <div class="ui grid">
        <div class="ui column" style="width: 75px; padding-top: 50px;">
            {% include 'new_ui/project/sidebar.html' %}
        </div>
        <div class="ui column" style="width: calc(100% - 75px)">
            <h1 class="ui dividing header">Host: {{ escape(current_host['ip']) }}</h1>
            <div class="ui container" style="width: 100%">
                <div class="ui grid" id="host_page">
                    <div class="column" style="width: 170px;">
                        <div class="ui sticky" id="host_menu">
                            <div class="ui vertical fluid tabular menu" id="hosts_tab_names">
                                <a class="item active" data-tab="ports">
                                    Ports<i class="fork icon"></i>
                                </a>
                                <a class="item" data-tab="hostnames">
                                    Hostnames<i class="globe icon"></i>
                                </a>
                                <a class="item" data-tab="issues">
                                    Issues<i class="bug icon"></i>
                                </a>
                                <a class="item" data-tab="credentials">
                                    Credentials<i class="key icon"></i>
                                </a>
                                <a class="item" data-tab="files">
                                    Files<i class="open folder icon"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="stretched column" style="width: calc(100% - 200px)" id="host_tabs">
                        <div class="ui tab active" data-tab="ports">
                            {% set ports = db.select_host_ports(current_host['id']) %}
                            <table class="ui table" id="ports_list">
                                <thead>
                                <tr>
                                    <th>port</th>
                                    <th>service</th>
                                    <th>description</th>
                                    <th>threats</th>
                                    <th style="width:135px;">action</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for current_port in ports %}
                                    <tr>
                                        <td id="port_num_{{ loop.index }}" data-order="{{ current_port['port'] }}">{{ current_port['port'] }}/{% if current_port['is_tcp'] %}tcp{% else %}udp{% endif %}</td>
                                        <td id="port_service_{{ loop.index }}">{{ escape(current_port['service']) }}</td>
                                        <td id="port_description_{{ loop.index }}">{{ escape(current_port['description']) }}</td>
                                        <td>
                                            {% set threats = db.select_port_issues_stats(current_port['id']) %}
                                            {% if threats['critical'] %}
                                                <i class="warning circle big red icon"></i>
                                            {% endif %}
                                            {% if threats['high'] %}
                                                <i class="warning circle big orange icon"></i>
                                            {% endif %}
                                            {% if threats['medium'] %}
                                                <i class="warning circle big yellow icon"></i>
                                            {% endif %}
                                            {% if threats['low'] %}
                                                <i class="warning circle big green icon"></i>
                                            {% endif %}
                                            {% if threats['info'] %}
                                                <i class="warning circle big blue icon"></i>
                                            {% endif %}
                                        </td>
                                        <td style="width:135px;">
                                            <form style="width:135px;" method="post" action="/project/{{ current_project['id'] }}/host/{{ current_host['id'] }}/#/ports" onsubmit="return delete_prompt(this,'Are you sure to delete port {{ escape(current_port['port']) }}?')">
                                                <input type="hidden" name="delete_port" value="1"/>
                                                <input type="hidden" name="port_id" value="{{ current_port['id'] }}"/>
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="button" class="ui vertical animated button purple" onclick="copy_data('{{ loop.index }}')">
                                                    <div class="hidden content">Edit</div>
                                                    <div class="visible content">
                                                        <i class="edit icon"></i>
                                                    </div>
                                                </button>
                                                <button type="submit" class="ui vertical animated button red">
                                                    <div class="hidden content">Delete</div>
                                                    <div class="visible content">
                                                        <i class="trash icon"></i>
                                                    </div>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <h3 class="ui dividing header">Edit/Create port:</h3>
                            <form class="ui form" method="post" action="/project/{{ current_project['id'] }}/host/{{ current_host['id'] }}/#/ports" id="port_edit_form">
                                <input type="hidden" name="add_port" value="1"/>
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="four fields">
                                    <div class="ui field">
                                        <label>Port number:</label>
                                        <input placeholder="80/tcp" name="port" id="port" required>
                                    </div>
                                    <div class="ui field">
                                        <label>Port service:</label>
                                        <div class="ui field">
                                            <select class="ui dropdown selection search" name="service" id="services_list">
                                                <option value="http" selected>HTTP</option>
                                                <option value="https">HTTPS</option>
                                                <option value="dns">DNS</option>
                                                <option value="ftp">FTP</option>
                                                <option value="telnet">Telnet</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <label>or</label>
                                        <input placeholder="Other protocol" name="service_text" id="service_text">
                                    </div>
                                    <div class="ui field" style="width:calc(50% - 130px);">
                                        <label>Port information:</label>
                                        <textarea placeholder="Information about service" name="description" id="port_descr"></textarea>
                                    </div>
                                    <div class="ui field" style="width:130px">
                                        <button type="submit" name="Submit" value="Submit" class="ui button blue"><i class="upload icon"></i>Update</button>
                                    </div>
                                </div>
                            </form>
                            {% if add_port_errors is defined and add_port_errors %}
                                <div class="ui error message visible">
                                    <i class="close icon"></i>
                                    <div class="header">
                                        There were some errors with credentials
                                    </div>
                                    <ul class="list">
                                        {% for error in add_port_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                        <div class="ui tab" data-tab="hostnames">
                            <table class="ui table" id="hostnames_list">
                                <thead>
                                <tr>
                                    <th>hostname</th>
                                    <th>description</th>
                                    <th style="width:135px;">action</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% set hostnames = db.select_ip_hostnames(current_host['id']) %}
                                {% for hostname in hostnames %}
                                    <tr>
                                        <td id="hostname_{{ loop.index }}">{{ escape(hostname['hostname']) }}</td>
                                        <td id="hostname_comment_{{ loop.index }}">{{ escape(hostname['description']) }}</td>
                                        <td style="width:135px;">
                                            <form style="width:135px;" method="post" action="/project/{{ current_project['id'] }}/host/{{ current_host['id'] }}/#/hostnames" onsubmit="return delete_prompt(this,'Are you sure to delete hostname {{ escape(hostname['hostname']) }}?')">
                                                <input type="hidden" name="delete_hostname" value="1"/>
                                                <input type="hidden" name="hostname_id" value="{{ hostname['id'] }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="button" class="ui vertical animated button purple" onclick="copy_hostname('{{ loop.index }}');">
                                                    <div class="hidden content">Edit</div>
                                                    <div class="visible content">
                                                        <i class="edit icon"></i>
                                                    </div>
                                                </button>
                                                <button type="submit" class="ui vertical animated button red">
                                                    <div class="hidden content">Delete</div>
                                                    <div class="visible content">
                                                        <i class="trash icon"></i>
                                                    </div>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <h3 class="ui dividing header">Edit/Create hostname:</h3>
                            <form id="add_hostname_form" class="ui form" method="post" action="/project/{{ current_project['id'] }}/host/{{ current_host['id'] }}/#/hostnames">
                                <input type="hidden" name="add_hostname" value="1"/>
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="three fields">
                                    <div class="ui field">
                                        <label>Hostname:</label>
                                        <input placeholder="google.com" name="hostname" id="hostname_field" required>
                                    </div>
                                    <div class="ui field">
                                        <label>Comment:</label>
                                        <input placeholder="Main domain of" name="comment" id="hostname_comment">
                                    </div>
                                    <div class="ui field">
                                        <button type="submit" name="Submit" value="Submit" class="ui button blue" style="margin-top:24px;"><i class="upload icon"></i>Submit</button>
                                    </div>
                                </div>
                            </form>
                            {% if add_hostname_errors is defined and add_hostname_errors %}
                                <div class="ui error message visible">
                                    <i class="close icon"></i>
                                    <div class="header">
                                        There were some errors with hostname
                                    </div>
                                    <ul class="list">
                                        {% for error in add_hostname_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                        <div class="ui tab" data-tab="issues">4</div>
                        <div class="ui tab" data-tab="credentials">5</div>
                        <div class="ui tab" data-tab="files">6</div>
                        <div style="height:200px"></div>
                        <div class="host_footer" style="position: fixed; bottom: 0; width:calc(100% - 300px); background-color: white; margin-right: 150px;z-index: 3;">
                            <h3 class="ui dividing header" style="margin-top:15px;">Host information:</h3>
                            <form class="ui form" action="/project/{{ current_project['id'] }}/host/{{ current_host['id'] }}/" method="post" onsubmit="return delete_prompt(this,'Are you sure to edit or delete host?');">
                                <input type="hidden" name="update_description" value="1"/>
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="three fields">
                                    <div class="ui field">
                                        <label>Host comment:</label>
                                        <textarea placeholder="Example text" name="comment">{{ escape(current_host['comment']) }}</textarea>
                                    </div>
                                    <div class="ui field">
                                        {% set current_threats=json_unpack(current_host['threats']) %}
                                        <div class="grouped fields">
                                            <label>Threats:</label>
                                            <div class="field" style="margin-bottom:0px;margin-top:0px;">
                                                <div class="ui checkbox">
                                                    <input type="checkbox" name="threats-0" value="high" {% if 'high' in current_threats %} checked {% endif %}>
                                                    <label><i class="warning circle red icon"></i>High</label>
                                                </div>
                                            </div>
                                            <div class="field" style="margin-bottom:0px; margin-top:0px;">
                                                <div class="ui checkbox">
                                                    <input type="checkbox" name="threats-1" value="medium" {% if 'medium' in current_threats %} checked {% endif %}>
                                                    <label><i class="warning circle yellow icon"></i>Medium</label>
                                                </div>
                                            </div>
                                            <div class="field" style="margin-bottom:0px; margin-top:0px;">
                                                <div class="ui checkbox">
                                                    <input type="checkbox" name="threats-2" value="low" {% if 'low' in current_threats %} checked {% endif %}>
                                                    <label><i class="warning circle green icon"></i>Low</label>
                                                </div>
                                            </div>
                                            <div class="field" style="margin-bottom:0px; margin-top:0px;">
                                                <div class="ui checkbox">
                                                    <input type="checkbox" name="threats-3" value="info" {% if 'info' in current_threats %} checked {% endif %}>
                                                    <label><i class="warning circle blue icon"></i>Information</label>
                                                </div>
                                            </div>
                                            <div class="field" style="margin-bottom:0px; margin-top:0px;">
                                                <div class="ui checkbox">
                                                    <input type="checkbox" name="threats-4" value="check" {% if 'check' in current_threats %} checked {% endif %}>
                                                    <label><i class="help circle purple icon"></i>Need to check</label>
                                                </div>
                                            </div>
                                            <div class="field" style="margin-bottom:0px; margin-top:0px;">
                                                <div class="ui checkbox">
                                                    <input type="checkbox" name="threats-5" value="checked" {% if 'checked' in current_threats %} checked {% endif %}>
                                                    <label><i class="flag red icon"></i>Checked</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui field">
                                            <label>Operation system:</label>
                                            <select class="ui dropdown selection search" name="os" id="os_list">
                                                <option value="" selected>other</option>
                                                <option value="Windows XP">Windows XP</option>
                                                <option value="Windows 7">Windows 7</option>
                                                <option value="Windows 8">Windows 8</option>
                                                <option value="Windows 10">Windows 10</option>
                                                <option value="Windows Server 2008">Windows Server 2008</option>
                                                <option value="Window Server 2016">Window Server 2016</option>
                                                <option value="Window Server 2019">Window Server 2019</option>
                                                <option value="MacOS">MacOS</option>
                                                <option value="Ubuntu Linux">Ubuntu Linux</option>
                                                <option value="Debian Linux">Debian Linux</option>
                                                <option value="CentOS Linux">CentOS Linux</option>
                                                <option value="RedHat Linux">RedHat Linux</option>
                                            </select>
                                        </div>
                                        <label>or</label>
                                        <div class="ui field">
                                            <div class="ui input">
                                                <input type="text" name="os_input" placeholder="Windows 7" value="{{ current_host['os'] }}">
                                            </div>
                                        </div>
                                        <div class="ui field" style="margin-top:15px;">
                                            <button type="submit" name="Submit" value="Update" class="ui button purple"><i class="sync icon"></i>Update</button>
                                            <button type="submit" name="Submit" value="Delete" class="ui button red"><i class="trash icon"></i>Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'new_ui/footer.html' %}
</div>
</div>
</body>
</html>